# Health Checks

## Health Checks

* AWS Route 53의 **Health Check** 기능은 웹 애플리케이션 및 기타 인터넷 리소스의 상태를 모니터링하고, 장애가 발생하면 트래픽을 자동으로 다른 리소스로 라우팅하여 가용성을 유지하는 중요한 도구.

### 주요 기능

1. **Endpoint Monitoring**  
특정 엔드포인트(예: 웹 서버, API 서버, 데이터베이스 등)를 모니터링.
2. **Protocol Support**  
HTTP, HTTPS, TCP 프로토콜을 지원하여 다양한 타입의 엔드포인트를 모니터링할 수 있음.
3. **Failover and Recovery**  
엔드포인트가 비정상 상태로 판단되면, 트래픽을 다른 정상 엔드포인트로 라우팅.
4. **Latency Monitoring**  
엔드포인트의 지연 시간을 측정하고, 이를 기반으로 라우팅 결정을 내릴 수 있음.
5. **Global Health Checkers**  
전 세계 여러 AWS 리전에서 Health Check를 수행하여 글로벌 가용성을 보장.
6. **Alarm Integration**  
Amazon CloudWatch와 통합되어 Health Check 상태 변화에 대한 알림을 받을 수 있음.

## Public Resource Health Check

* AWS Route 53의 Health Check는 기본적으로 퍼블릭 리소스를 모니터링하는 데 사용됨. 
* 퍼블릭 리소스란 인터넷에서 접근 가능한 리소스를 의미.

### 퍼블릭 리소스

* **인터넷 접근 가능**  
기본적인 헬스 체크는 인터넷에서 접근 가능한 **퍼블릭 IP 주소**나 **DNS 이름**을 모니터링.  
예를 들어, 웹 서버나 API 엔드포인트가 퍼블릭 IP 주소를 가지고 있다면, Route 53의 헬스 체크를 통해 그 상태를 모니터링할 수 있음.

## Private Resource Health Check

퍼블릭 리소스 외에도 프라이빗 리소스에 대해 헬스 체크를 수행하려면 **Amazon VPC**와의 통합을 활용해야 함.

### Private Resource

* **Amazon VPC Endpoint**  
프라이빗 리소스가 VPC 내부에 있을 경우, **VPC 엔드포인트**를 설정하여 Route 53 헬스 체크가 VPC 내 리소스에 접근할 수 있도록 함.  
이는 AWS PrivateLink를 활용하여 프라이빗 리소스에 대한 헬스 체크를 가능하게 함.

* **Lambda 함수와 통합**  
Route 53 헬스 체크가 직접 프라이빗 리소스를 모니터링할 수 없는 경우, AWS **Lambda 함수**를 사용하여 VPC 내부에서 실행되는 헬스 체크를 설정할 수 있음.  
Lambda 함수는 VPC 내에서 리소스를 체크하고 그 결과를 Route 53 헬스 체크와 연동할 수 있음.

## Automated DNS Failover

* **Automated DNS Failover**는 헬스 체크 결과에 따라 트래픽을 다른 리소스로 자동으로 전환하는 메커니즘.  
* 만약 헬스 체크가 실패하여 특정 리소스가 비정상 상태임을 감지하면, Route 53은 사전 정의된 **대체 리소스로 DNS 응답을 변경하여 트래픽을 전환**함.

## Calculated Health Checks

**Calculated Health Checks**는 하나 이상의 기존 헬스 체크를 결합하여 **복합적인 헬스 상태를 모니터링할 수 있는 기능**.  
이는 특정 조건에 따라 헬스 체크 상태를 정의함으로써 보다 정교한 모니터링 및 대응을 가능하게 함.

### 특징
1. **다중 헬스 체크 결합**  
    * **여러 개의 헬스 체크를 결합**하여 하나의 논리적인 헬스 체크를 구성할 수 있음.
    * 예를 들어, 두 개의 웹 서버가 모두 비정상일 때 계산된 헬스 체크가 비정상 상태로 간주되도록 설정할 수 있음.

2. **논리 연산자 사용**  
    * AND, OR, NOT 등의 논리 연산자를 사용하여 복잡한 헬스 체크 조건을 정의할 수 있음.
    * 예를 들어, "헬스 체크 A AND 헬스 체크 B"와 같이 설정하여 두 조건이 모두 충족될 때만 정상으로 간주할 수 있음.

3. **간단한 설정**
    * AWS Management Console 또는 AWS CLI를 통해 쉽게 설정할 수 있음.
    * 기존 헬스 체크를 선택하고 논리 조건을 정의하면 됨.

## 과정

1. **헬스 체크 설정**  
    * Route 53은 사용자가 설정한 헬스 체크를 통해 특정 리소스의 상태를 주기적으로 모니터링.
    * 헬스 체크는 HTTP, HTTPS, 또는 TCP를 통해 리소스에 요청을 보내고, 응답 상태를 기반으로 리소스의 가용성을 판단.

2. **헬스 체크 수행**  
    * 헬스 체크는 지정된 간격으로 리소스에 접근하여 정상 응답(200 OK 등)을 기대.
    * 응답이 없거나 오류 응답이 반환되면, 헬스 체크는 이를 실패로 기록.

3. **헬스 체크 결과 수집 및 분석**
    * 여러 지역에 분산된 **헬스 체크 노드**가 독립적으로 헬스 체크를 수행하고, 결과를 수집.
    * 일정 횟수 이상의 연속된 실패가 발생하면 리소스가 비정상 상태로 간주.

4. **DNS 페일오버 수행**:
    * 비정상 상태가 감지된 리소스의 DNS 레코드가 **비활성화되거나 대체 리소스로 변경**.
    * Route 53은 헬스 체크 실패 시, 사전에 정의된 대체 리소스의 DNS 레코드로 응답을 전환.
    * 트래픽은 자동으로 대체 리소스로 라우팅되어 서비스의 가용성을 유지.

## Summary

* AWS Route 53의 **Health Check** 기능은 엔드포인트의 상태를 모니터링하고, 장애 발생 시 트래픽을 다른 리소스로 라우팅하여 높은 가용성을 유지. 
* 다양한 설정 옵션을 통해 유연하게 구성할 수 있으며, CloudWatch와의 통합을 통해 실시간 모니터링 및 경보 기능을 제공.  
* Health Check를 설정하고 사용하는 방법에는 AWS Management Console, AWS CLI, SDK/API를 활용할 수 있음.
* Route 53의 헬스 체크와 자동화된 DNS 페일오버는 서비스 중단을 최소화하고, 고가용성과 복원력을 유지하는 데 중요한 역할.
* 분산된 헬스 체크 노드와 자동화된 DNS 응답 조정 기능을 통해 다양한 장애 상황에서도 신속하게 대처할 수 있음.